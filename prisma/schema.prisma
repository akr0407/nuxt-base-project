// Prisma Schema for Nuxt Base Project
// Multi-Tenant RBAC: Tenant, User, Role, Permission, RolePermission, UserRole

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String          @id @default(uuid())
  name           String          @unique
  slug           String          @unique
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  users          User[]
  roles          Role[]
  settings       Settings[]
  themeTemplates ThemeTemplate[]

  @@map("tenants")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String?
  isActive      Boolean        @default(true)
  isSuperAdmin  Boolean        @default(false)
  tenantId      String?
  tenant        Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userRoles     UserRole[]
  refreshTokens RefreshToken[]

  @@index([tenantId])
  @@map("users")
}

model Role {
  id              String           @id @default(uuid())
  name            String
  description     String?
  isGlobal        Boolean          @default(false)
  tenantId        String?
  tenant          Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id              String           @id @default(uuid())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now())

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId     String
  roleId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@map("user_roles")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Settings {
  id        String   @id @default(uuid())
  key       String
  value     Json
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("settings")
}

model ThemeTemplate {
  id        String   @id @default(uuid())
  name      String
  settings  Json
  isDefault Boolean  @default(false)
  isGlobal  Boolean  @default(false)
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("theme_templates")
}

